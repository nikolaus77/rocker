---
output:
  github_document:
    toc: true
    toc_depth: 2
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# *rocker* -- *R6* database interface class wrapping *DBI*

<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/rocker)](https://cran.r-project.org/package=rocker)
[![GitHub version](https://img.shields.io/badge/devel%20version-0.1.2.9015-yellow.svg)](https://github.com/nikolaus77/rocker)
[![R-CMD-check](https://github.com/nikolaus77/rocker/actions/workflows/check-standard.yaml/badge.svg)](https://github.com/nikolaus77/rocker/actions/workflows/check-standard.yaml)
[![License: MIT](https://img.shields.io/badge/license-MIT-blue.svg)](https://opensource.org/licenses/MIT)
<!-- badges: end -->

[*R6*](https://github.com/r-lib/R6) class interface for handling database connections using [*DBI*](https://github.com/r-dbi/DBI) package as backend.
The class allows handling of connections to e.g. [PostgreSQL](https://www.postgresql.org), [MariaDB](https://mariadb.org) and [SQLite](https://www.sqlite.org).
The purpose is having an intuitive object allowing straightforward handling of databases. 

# Installation

Installation of current released version from CRAN

```{r, eval = FALSE}
install.packages("rocker")
```

Installation of current development version from GitHub

```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("nikolaus77/rocker")
```

# New *rocker* class object

Create new *rocker* database handling object

Option 1

```{r}
db <- rocker::newDB() # New database handling object
```

Option 2

```{r}
db <- rocker::rocker$new() # New database handling object
```

__Terminal output__

Controlling terminal output

```{r}
db <- rocker::newDB(verbose = TRUE) # New database handling object
db$verbose <- FALSE # Terminal output off
db$verbose <- TRUE # Terminal output on (default)
```

Structure of terminal output

```
Dctr | Driver load RSQLite
D                          = Driver     (D = loaded,    d = not set)
 c                         = Connection (C = opened,    c = closed)
  t                        = Transation (T = active,    t = no tranastion)
   r                       = Result     (R = available, r = no result)
       Driver load RSQLite = Message text

```

__Optional object ID__

```{r}
db <- rocker::newDB(id = "myDB") # New database handling object with ID
db$id <- NULL # Remove ID
db$print()
db$id <- "newID" # Add new ID
db$print()
```

# Additional packages and database types

The listed packages are required for some functions of *rocker*.

## *crayon* package

The [*crayon*](https://github.com/r-lib/crayon) package is required for colored terminal output.
If missing terminal output is monochrome.

```{r, eval = FALSE}
install.packages("crayon")
```

## *RSQLite* package

[*RSQLite*](https://github.com/r-dbi/RSQLite) package for handling of SQLite database connections.
It is required for the setupSQLite() function of *rocker* class.

```{r, eval = FALSE}
install.packages("RSQLite")
```

__Setup database__

Option 1

```{r}
db <- rocker::newDB() # New database handling object
db$setupSQLite( # Setup SQLite database
  dbname = ":memory:"
)
db$unloadDriver() # Reset database handling object
```

Option 2

```{r}
db <- rocker::newDB() # New database handling object
db$setupDriver( # Setup SQLite database
  drv = RSQLite::SQLite(),
  dbname = ":memory:"
)
db$unloadDriver() # Reset database handling object
```

## *RPostgres* package

[*RPostgres*](https://github.com/r-dbi/RPostgres) package for handling of PostgreSQL database connections.
It is required for the setupPostgreSQL() function of *rocker* class.

```{r, eval = FALSE}
install.packages("RPostgres")
```

__Setup database__

Option 1

```{r}
db <- rocker::newDB() # New database handling object
db$setupPostgreSQL( # Setup PostgreSQL database
  host = "127.0.0.1", port = "5432", dbname = "mydb",
  user = "postgres", password = "password"
)
db$unloadDriver() # Reset database handling object
```

Option 2

```{r}
db <- rocker::newDB() # New database handling object
db$setupDriver( # Setup PostgreSQL database
  drv = RPostgres::Postgres(),
  host = "127.0.0.1", port = "5432", dbname = "mydb",
  user = "postgres", password = "password"
)
db$unloadDriver() # Reset database handling object
```

## *RMariaDB* package

[*RMariaDB*](https://github.com/r-dbi/RMariaDB) package for handling of MariaDB and MySQL database connections.
It is required for the setupMariaDB() function of *rocker* class.

```{r, eval = FALSE}
install.packages("RMariaDB")
```

__Setup database__

Option 1

```{r}
db <- rocker::newDB() # New database handling object
db$setupMariaDB( # Setup MariaDB database
  host = "127.0.0.1", port = "3306", dbname = "mydb",
  user = "root", password = "password"
)
db$unloadDriver() # Reset database handling object
```

Option 2

```{r}
db <- rocker::newDB() # New database handling object
db$setupDriver( # Setup MariaDB database
  drv = RMariaDB::MariaDB(),
  host = "127.0.0.1", port = "3306", dbname = "mydb",
  user = "root", password = "password"
)
db$unloadDriver() # Reset database handling object
```

# Database connection

There are different ways to open a connection and to get data.

Prepare database with a table

```{r}
db <- rocker::newDB() # New database handling object
db$setupSQLite(dbname = tempfile()) # Setup SQLite database
db$connect() # Open connection
db$writeTable("mtcars", mtcars) # Create table for testing
db$disconnect() # Close connection
```

__Example 1__

Get query with automatic connection / disconnection

```{r}
output <- db$getQuery("SELECT * FROM mtcars;") # Get query
```

__Example 2__

Get query with manual connection / disconnection

```{r}
db$connect() # Open connection
output1 <- db$getQuery("SELECT * FROM mtcars;") # Get query 1
output2 <- db$getQuery("SELECT * FROM mtcars;", 15) # Get query 2
db$disconnect() # Close connection
```

__Example 3__

Function getQuery() is a combination of functions sendQuery(), fetch() and clearResult().

```{r}
db$connect() # Open connection
db$sendQuery("SELECT * FROM mtcars;") # Send query
output <- db$fetch() # Fetch result
db$clearResult() # Clean up result
db$disconnect() # Close connection
```

Clean up

```{r}
db$unloadDriver() # Reset database handling object
```

# Password storage

Some efforts were undertaken to encrypt and to protect the password in the private area of the class. The class stores the password hidden and inaccessible. __Please let me know, in case you discover a way how to access the password!__

```{r}
db <- rocker::newDB() # New database handling object
db$setupDriver( # Setup PostgreSQL database with stored password (password and user are hidden - default behavior)
  RPostgres::Postgres(),
  host = "127.0.0.1", port = "5432", dbname = "mydb",
  user = "postgres", password = "password",
  protect = c("password", "user")
)
```

```{r}
db$connect() # Open connection 1; Password is stored in the class and does not need to be provided.
output1 <- db$getQuery("SELECT * FROM mtcars;") # Get query 1
db$disconnect() # Close connection 1
```

```{r}
db$connect() # Open connection 2; Password is stored in the class and does not need to be provided.
output2 <- db$getQuery("SELECT * FROM mtcars;") # Get query 2
db$disconnect() # Close connection 2
```

```{r}
db$unloadDriver() # Reset database handling object
```

In case you do not want to store the password in the class, you will need to provide it each time a connection is opened.

```{r}
db <- rocker::newDB() # New database handling object
db$setupDriver( # Setup PostgreSQL database without stored password
  RPostgres::Postgres(),
  host = "127.0.0.1", port = "5432", dbname = "mydb",
  user = "postgres"
)
```

```{r}
db$connect(password = "password") # Open connection 1; Password needs to be provided.
output1 <- db$getQuery("SELECT * FROM mtcars;") # Get query 1
db$disconnect() # Close connection 1
```

```{r}
db$connect(password = "password") # Open connection 2; Password needs to be provided.
output2 <- db$getQuery("SELECT * FROM mtcars;") # Get query 2
db$disconnect() # Close connection 2
```

```{r}
db$unloadDriver() # Reset database handling object
```

# *DBI* objects

*rocker* class encapsulates the *DBI* objects driver, connection and result.
If required, these objects can be directly used with *DBI* functions.
__However, it is recommended to use this option with care!__ Direct usage of *DBI* functions, may disrupt proper function of *rocker* class. Many *DBI* functions are implemented in *rocker* class. Whenever possible, use the *rocker* class functions.

Prepare object

```{r}
db <- rocker::newDB() # New database handling object
db$.drv # Empty driver
db$.con # Empty connection
db$.res # Empty result
```

## DBIDriver-class

```{r}
db$setupSQLite() # Setup SQLite database
db$.drv # 'DBI' DBIDriver-class
```

```{r}
db$getInfoDrv() # 'rocker' class function
```

```{r}
DBI::dbGetInfo(db$.drv) # Direct usage of 'DBI' function on 'rocker' class
```

```{r}
RSQLite::dbGetInfo(db$.drv) # Direct usage of driver package, 'RSQLite', function on 'rocker' class
```

## DBIConnection-class

```{r}
db$connect() # Open connection
db$.con # 'DBI' DBIConnection-class
```

```{r}
db$getInfoCon() # 'rocker' class function
```

```{r}
DBI::dbGetInfo(db$.con) # Direct usage of 'DBI' function on 'rocker' class
```

```{r}
RSQLite::dbGetInfo(db$.con) # Direct usage of driver package, 'RSQLite', function on 'rocker' class
```

Prepare table

```{r}
db$writeTable("mtcars", mtcars) # Create table for testing
```

## DBIResult-class

```{r}
db$sendQuery("SELECT * FROM mtcars;") # Send query
db$.res # 'DBI' DBIResult-class
```

```{r}
db$getInfoRes() # 'rocker' class function
```

```{r}
DBI::dbGetInfo(db$.res) # Direct usage of 'DBI' function on 'rocker' class
```

```{r}
RSQLite::dbGetInfo(db$.res) # Direct usage of driver package, 'RSQLite', function on 'rocker' class
```

Clean up

```{r}
db$clearResult() # Clean up result
db$.res # Empty result
db$disconnect() # Close connection
db$.con # Empty connection
db$unloadDriver() # Reset database handling object
db$.drv # Empty driver
```

# *DBI* functions in *rocker*

Generally, *rocker* function names are related to *DBI* function names. In *rocker* functions, the leading __db__ is removed.

In *DBI* most functions need to be supplied with a driver ^(drv)^, connection ^(conn)^ or result ^(res)^ object. In *rocker*, functions automatically access the corresponding objects ^(.drv,^ ^.con^ ^and^ ^.res)^ stored in the class. 

__*DBI* example__

```{r}
drv <- RSQLite::SQLite() # SQLite driver
DBI::dbCanConnect( # Test parameter
  drv = drv,
  dbname = ":memory:"
)
con <- DBI::dbConnect( # Open connection
  drv = drv,
  dbname = ":memory:"
)
DBI::dbWriteTable(con, "mtcars", mtcars) # Create table for testing
res <- DBI::dbSendQuery(con, "SELECT * FROM mtcars;") # Send query
output <- DBI::dbFetch(res) # Fetch result
DBI::dbClearResult(res) # Clean up result
DBI::dbDisconnect(con) # Close connection
DBI::dbUnloadDriver(drv) # Unload driver
```

__*rocker* example__

```{r}
db <- rocker::newDB(verbose = FALSE) # New database handling object
db$setupDriver( # Setup SQLite database
  drv = RSQLite::SQLite(),
  dbname = ":memory:"
)
db$canConnect() # Test parameter
db$connect() # Open connection
db$writeTable("mtcars", mtcars) # Create table for testing
db$sendQuery("SELECT * FROM mtcars;") # Send query
output <- db$fetch() # Fetch result
db$clearResult() # Clean up result
db$disconnect() # Close connection
db$unloadDriver() # Reset database handling object
```

## List of functions

| *rocker* function | Corresponding *DBI* function | *DBI* object used | Comment |
| --- | --- | --- | --- |
| initialize() | *none* | *none* | |
| print() | *none* | *none* | |
| setupDriver() | *none* | *driver from appropriate package* | Usually, parameters provided to dbConnect() in *DBI* are provided to setupDriver() in *rocker*  |
| setupPostgreSQL() | *none* | *none* | RPostgres::Postgres() is used with *rocker* function setupDriver() |
| setupMariaDB() | *none* | *none* | RMariaDB::MariaDB() is used with *rocker* function setupDriver() |
| setupSQLite() | *none* | *none* | RSQLite::SQLite() is used with *rocker* function setupDriver() |
| unloadDriver() | dbUnloadDriver() | driver | |
| canConnect() | dbCanConnect() | driver | Usually, parameters provided to dbCanConnect() in *DBI* are provided to setupDriver() in *rocker* |
| connect() | dbConnect() | driver | Usually, parameters provided to dbConnect() in *DBI* are provided to setupDriver() in *rocker*  |
| disconnect() | dbDisconnect() | connection | |
| sendQuery() | dbSendQuery() | connection | |
| getQuery() | Is __not__ using dbGetQuery(), but has the same function | connection | Especially, combination of *rocker* functions sendQuery(), fetch() and clearResult()  |
| sendStatement() | dbSendStatement() | connection | |
| execute() | Is __not__ using dbExecute(), but has the same function | connection | Especially, combination of *rocker* functions sendStatement() and clearResult() |
| fetch() | dbFetch() | result | |
| hasCompleted() | dbHasCompleted() | result | |
| getRowsAffected() | dbGetRowsAffected() | result | |
| getRowCount() | dbGetRowCount() | result | |
| columnInfo() | dbColumnInfo() | result | |
| getStatement() | dbGetStatement() | result | |
| clearResult() | dbClearResult() | result | |
| begin() | dbBegin() | connection | |
| commit() | dbCommit() | connection | |
| rollback() | dbRollback() | connection | |
| getInfoDrv() | dbGetInfo() | driver | |
| getInfoCon() | dbGetInfo() | connection | |
| getInfoRes() | dbGetInfo() | result | |
| isValidDrv() | dbIsValid() | driver | |
| isValidCon() | dbIsValid() | connection | |
| isValidRes() | dbIsValid() | result | |
| createTable() | dbCreateTable() | connection | |
| appendTable() | dbAppendTable() | connection | |
| writeTable() | dbWriteTable | connection | |
| readTable() | dbReadTable | connection | |
| removeTable() | dbRemoveTable() | connection | |
| existsTable() | dbExistsTable() | connection | |
| listFields() | dbListFields() | connection | |
| listObjects() | dbListObjects() | connection | |
| listTables() | dbListTables() | connection | |

# Transaction

Setup database and a table with 32 rows.

```{r}
db <- rocker::newDB() # New database handling object
db$setupSQLite() # Setup SQLite database
db$connect() # Open connection
db$writeTable("mtcars", mtcars) # Create table for testing
output <- db$getQuery("SELECT * FROM mtcars;") # Get query -> 32 rows
db$transaction # Transaction indicator
```

Starting with a table with 32 rows, begin transaction 1. Delete 15 rows and commit transaction. Operations results in a table with 17 rows.

```{r}
db$begin() # Start transaction 1
db$transaction # Transaction indicator
AFFECTED <- db$execute("DELETE FROM mtcars WHERE gear = 3;") # Modify table -> 15 rows
db$commit() # Commit transaction 1
db$transaction # Transaction indicator
output <- db$getQuery("SELECT * FROM mtcars;") # Get query -> 17 rows
```

Starting with a table with 17 rows, begin transaction 2. Delete 5 rows and rollback transaction. Operations results in a table with 17 rows.

```{r}
db$begin() # Start transaction 2
db$transaction # Transaction indicator
AFFECTED <- db$execute("DELETE FROM mtcars WHERE gear = 5;") # Modify table -> 5 rows
output <- db$getQuery("SELECT * FROM mtcars;") # Get query -> 12 rows
db$rollback() # Rollback transaction 2
db$transaction # Transaction indicator
output <- db$getQuery("SELECT * FROM mtcars;") # Get query -> 17 rows
```

Clean up

```{r}
db$disconnect() # Close connection
db$unloadDriver() # Reset database handling object
```

# Further help

Please read the documentation of *rocker* class.

```{r, eval = FALSE}
help(rocker)
```

Reading of *DBI* package documentation is recommended.

* [CRAN](https://cran.r-project.org/package=DBI)
* [GitHub](https://github.com/r-dbi/DBI)
